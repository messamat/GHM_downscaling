import osgeo.gdal
import pandas as pd
from osgeo import ogr, gdal

def create_stationrastermapping(in_flowacc_path, in_stations_vector,  outputdir):
    driver = ogr.GetDriverByName('GeoJSON')
    datasource = driver.Open(in_stations_vector)
    stations = datasource.GetLayer()
    gt = gdal.Open(in_flowacc_path).GetGeoTransform()

    def get_row_col(x, y):
        ulX = gt[0] #upper left corner x (longitude) in projection coordinates
        ulY = gt[3] #upper left corner y (latitude) in projection coordinates
        xDist = gt[1] #pixel width in the linear unit of the projection coordinate system
        col = int((x - ulX) / xDist)  #col index in raster
        row = int((ulY - y) / xDist) #row index in raster
        return row, col

    dflist = []
    for station in stations:
        srow, scol = get_row_col(station.GetGeometryRef().GetX(), station.GetGeometryRef().GetY())
        dflist.append([station.GetField('dd_id'), srow, scol, station.GetField('source')])
    df = pd.DataFrame(dflist)
    df.columns = ['stationid', 'row', 'col', 'metasource']
    df.to_csv('{}stations.csv'.format(outputdir))


if __name__ == '__main__':
    create_stationrastermapping('/home/home8/dryver/hs_reproduced/euassi_dir_15s.tif', '/home/home1/gm/projects/DRYvER/03_data/07_streamflowdata/04_stations/europe_stations.geojson', '/home/home8/dryver/hs_reproduced/')